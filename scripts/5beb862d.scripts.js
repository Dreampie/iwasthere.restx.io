"use strict";angular.module("iwasthereApp",["ngCookies","ngResource","ngSanitize","ngRoute","angular-md5"]).config(["$routeProvider",function(a){a.when("/events",{templateUrl:"views/events.html",controller:"EventsCtrl"}).when("/events/:key",{templateUrl:"views/event.html",controller:"EventCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/events"})}]).constant("$baseUrl",function(){return"iwasthere.restx.io"===location.host?"http://iwasthere-restx-io.herokuapp.com":"localhost:8077"===location.host?"http://localhost:8080":""}()),angular.module("iwasthereApp").factory("Session",["$resource","$baseUrl",function(a,b){var c=a(b+"/api/sessions/:sessionKey",{sessionKey:"current"},{get:{method:"GET",withCredentials:!0},save:{method:"POST",withCredentials:!0},"delete":{method:"DELETE",withCredentials:!0}});return c.user={connected:!1},c}]).factory("SecurityHttpInterceptor",["$q","$location",function(a,b){return function(c){return c.then(function(a){return a},function(c){return(401==c.status||403==c.status)&&b.path("/login"),a.reject(c)})}}]).config(["$httpProvider",function(a){a.responseInterceptors.push("SecurityHttpInterceptor")}]),angular.module("iwasthereApp").factory("Event",["$resource","$baseUrl",function(a,b){return a(b+"/api/events/:key",{key:"@_id"},{get:{method:"GET",withCredentials:!0},save:{method:"POST",withCredentials:!0}})}]).factory("Attendee",["$resource","$baseUrl",function(a,b){return a(b+"/api/events/:eventKey/attendees",{eventKey:"@eventRef"},{get:{method:"GET",withCredentials:!0},save:{method:"POST",withCredentials:!0}})}]).factory("Message",["$resource","$baseUrl",function(a,b){return a(b+"/api/events/:eventKey/attendees/:attendeeKey/messages",null,{save:{method:"POST",withCredentials:!0}})}]),angular.module("iwasthereApp").factory("User",["$resource","$baseUrl",function(a,b){return a(b+"/api/users/:email",null,{get:{method:"GET",withCredentials:!0},save:{method:"POST",withCredentials:!0}})}]),angular.module("iwasthereApp").controller("EventsCtrl",["$scope","Event",function(a,b){a.events=b.query(),a.addEvent=function(){var c=new b(a.event);c.$save(function(b){a.events.push(b),a.showAddEvent=!1})}}]),angular.module("iwasthereApp").controller("EventCtrl",["$scope","$routeParams","Event","Session","Attendee","Message","md5",function(a,b,c,d,e,f,g){function h(){a.message={text:"",mood:"blue"}}a.user=d.user,a.showImage=!0,h(),a.event=c.get({key:b.key}),a.addSelfAsAttendee=function(){var b=new e({eventRef:a.event._id,emailHash:g.createHash(a.user.email),fullName:a.user.fullName,img:"http://www.gravatar.com/avatar/"+g.createHash(a.user.email)+"?s=350"});b.$save(function(b){a.attendees.push(b),a.event.iwasthere=!0})},a.attendees=e.query({eventKey:b.key}),a.sendMessage=function(c){var d=new f(c);d.$save({eventKey:b.key,attendeeKey:g.createHash(a.user.email)},function(){a.attendees=e.query({eventKey:b.key}),h()})}}]),angular.module("iwasthereApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("iwasthereApp").controller("UserCtrl",["$rootScope","$scope","$location","Session","User",function(a,b,c,d,e){function f(a){d.user.connected=!0,d.user.email=a.email,d.user.fullName=a.fullName}b.user=d.user,b.$on("AUTHENTICATED",function(a,b){f(b)}),e.get({email:"current"}).$promise.then(f).catch(function(){d.user.connected=!1,delete d.user.fullName,delete d.user.email}),b.login=function(){c.path("/login")},b.logout=function(){d.delete(function(){location.reload()})}}]),angular.module("iwasthereApp").controller("LoginCtrl",["$scope","$rootScope","$http","$location","$baseUrl","md5",function(a,b,c,d,e,f){a.login={},a.submit=function(){c.post(e+"/api/sessions",{principal:{name:a.login.email,passwordHash:f.createHash(a.login.password)}},{withCredentials:!0}).success(function(a,c){console.log("authenticated",a,c),b.$broadcast("AUTHENTICATED",a.principal),d.path("/events")}).error(function(a,b){console.log("error",a,b),alert("Authentication error, please try again.")})}}]),angular.module("iwasthereApp").controller("SignupCtrl",["$scope","$rootScope","$location","User","md5",function(a,b,c,d,e){a.signup={},a.submit=function(){var f=new d(a.signup);f.passwordHash=e.createHash(f.password),delete f.password,f.$save(function(a){b.$broadcast("AUTHENTICATED",a),c.path("/events")})}}]);